services:
  web-server:
    image: node:24-bookworm
    container_name: web-server
    hostname: web-server
    user: "${UID:-1000}:${GID:-1000}"
    ports:
      - "8080:8080"
    restart: "no"
    command: bash -c "
              cd /app/src/webServer && \
              npm install && \
              node app.js"
    volumes:
      - ./:/app/
    depends_on:
      bloom-filter:
        condition: service_healthy
    networks:
      - bmail

  bloom-filter:
    build:
      context: .
      dockerfile: Dockerfile.server
    container_name: bloom-filter
    hostname: bloom-filter
    user: "${UID:-1000}:${GID:-1000}"
    restart: "no"
    command: bash -c "
              mkdir -p build/app && \
              cd build/app && \
              cmake ../.. && \
              make && \
              ./tcp-server 0.0.0.0 12345 8 1 2"
    volumes:
      - ./:/app
    ports:
      - "12345:12345"
    healthcheck:
      test: ["CMD", "bash", "-c", "exec 3<>/dev/tcp/localhost/12345"]
      interval: 3s
      timeout: 5s
      retries: 5

    networks:
      - bmail

networks:
  bmail:
    name: bmail